zerothorder_JUexp = :((Vz + -1 * sqrt(Δ^2 + ϵ^2)) * (adjoint(a[n]) * a[n]))#:(((adjoint(a[n]) * a[n]) * (μ[n]^2 + -1 * (Vz * sqrt(Δ^2 + μ[n]^2)) + Δ * sqrt(-1 * μ[n] + sqrt(Δ^2 + μ[n]^2)) * sqrt(μ[n] + sqrt(Δ^2 + μ[n]^2)))) * sqrt(Δ^2 + μ[n]^2)^-1);

firstorder_hopping_JUexp = :(((ℯ^((1im) * ϕ[n]) + ℯ^((1im) * ϕ[1+n])) * tso * Δ * sqrt(Δ^2 + ϵ^2) * (adjoint(a[n]) * adjoint(a[1+n])) + ℯ^((1im) * ϕ[1+n]) * t * (ℯ^((1im) * ϕ[1+n]) * sqrt((Δ^2 + ϵ^2) * (Δ^2 + 2 * ϵ * (ϵ + -1 * sqrt(Δ^2 + ϵ^2)))) + -1 * (ℯ^((1im) * ϕ[n]) * (Δ^2 + ϵ * (ϵ + sqrt(Δ^2 + ϵ^2))))) * (adjoint(a[n]) * a[1+n]) + ℯ^((1im) * ϕ[n]) * (t * (ℯ^((1im) * ϕ[n]) * sqrt((Δ^2 + ϵ^2) * (Δ^2 + 2 * ϵ * (ϵ + -1 * sqrt(Δ^2 + ϵ^2)))) + -1 * (ℯ^((1im) * ϕ[1+n]) * (Δ^2 + ϵ * (ϵ + sqrt(Δ^2 + ϵ^2))))) * (adjoint(a[1+n]) * a[n]) + -1 * (ℯ^((1im) * ϕ[1+n]) * (ℯ^((1im) * ϕ[n]) + ℯ^((1im) * ϕ[1+n])) * tso * Δ * sqrt(Δ^2 + ϵ^2) * (a[n] * a[1+n])))) * (2 * ℯ^((1im) * (ϕ[n] + ϕ[1+n])) * (Δ^2 + ϵ^2))^-1);#:((tso * (a[n] * a[1+n]) * (ℯ^((1im) * ϕ[1+n]) * sqrt(μ[n] + sqrt(Δ^2 + μ[n]^2)) * sqrt(-1 * μ[1+n] + sqrt(Δ^2 + μ[1+n]^2)) + ℯ^((1im) * ϕ[n]) * sqrt(-1 * μ[n] + sqrt(Δ^2 + μ[n]^2)) * sqrt(μ[1+n] + sqrt(Δ^2 + μ[1+n]^2))) + -1 * (tso * (adjoint(a[n]) * adjoint(a[1+n])) * (ℯ^((1im) * ϕ[n]) * sqrt(μ[n] + sqrt(Δ^2 + μ[n]^2)) * sqrt(-1 * μ[1+n] + sqrt(Δ^2 + μ[1+n]^2)) + ℯ^((1im) * ϕ[1+n]) * sqrt(-1 * μ[n] + sqrt(Δ^2 + μ[n]^2)) * sqrt(μ[1+n] + sqrt(Δ^2 + μ[1+n]^2)))) + t * (adjoint(a[n]) * a[1+n]) * (ℯ^((1im) * ϕ[1+n]) * sqrt(-1 * μ[n] + sqrt(Δ^2 + μ[n]^2)) * sqrt(-1 * μ[1+n] + sqrt(Δ^2 + μ[1+n]^2)) + -1 * (ℯ^((1im) * ϕ[n]) * sqrt(μ[n] + sqrt(Δ^2 + μ[n]^2)) * sqrt(μ[1+n] + sqrt(Δ^2 + μ[1+n]^2)))) + t * (adjoint(a[1+n]) * a[n]) * (ℯ^((1im) * ϕ[n]) * sqrt(-1 * μ[n] + sqrt(Δ^2 + μ[n]^2)) * sqrt(-1 * μ[1+n] + sqrt(Δ^2 + μ[1+n]^2)) + -1 * (ℯ^((1im) * ϕ[1+n]) * sqrt(μ[n] + sqrt(Δ^2 + μ[n]^2)) * sqrt(μ[1+n] + sqrt(Δ^2 + μ[1+n]^2))))) * (2 * ℯ^(((1im) * 2^-1) * (ϕ[n] + ϕ[1+n])) * (Δ^2 + μ[n]^2)^(1 * 4^-1) * (Δ^2 + μ[1+n]^2)^(1 * 4^-1))^-1);

secondorder_N2_nonint_JUexp = :((-1 * ((t^2 * Δ^2 + -1 * (tso^2 * (Δ^2 + 2 * ϵ^2)) + (t^2 * Δ^2 + tso^2 * (ϵ * sqrt(Δ^2 + 2 * ϵ * (ϵ + -1 * sqrt(Δ^2 + ϵ^2))) + sqrt((Δ^2 + ϵ^2) * (Δ^2 + 2 * ϵ * (ϵ + -1 * sqrt(Δ^2 + ϵ^2)))))) * cos(ϕ[1] + -1 * ϕ[2])) * (adjoint(a[1]) * a[1] + adjoint(a[2]) * a[2]))) * (2 * (Δ^2 + ϵ^2) * (Vz + sqrt(Δ^2 + ϵ^2)))^-1)

secondorder_N3_nonint_JUexp = :(
    (t * tso * Δ * (2 * ℯ^((2 * (1im)) * ϕ[2]) * (Δ^2 + ϵ * (ϵ + -1 * sqrt(Δ^2 + ϵ^2))) + -1 * (2 * ℯ^((1im) * (ϕ[1] + ϕ[3])) * sqrt((Δ^2 + ϵ^2) * (Δ^2 + 2 * ϵ * (ϵ + sqrt(Δ^2 + ϵ^2))))) + ℯ^((1im) * (ϕ[1] + ϕ[2])) * (Δ^2 + ϵ^2 + -1 * (ϵ * sqrt(Δ^2 + ϵ^2)) + -1 * sqrt((Δ^2 + ϵ^2) * (Δ^2 + 2 * ϵ * (ϵ + sqrt(Δ^2 + ϵ^2))))) + ℯ^((1im) * (ϕ[2] + ϕ[3])) * (Δ^2 + ϵ^2 + -1 * (ϵ * sqrt(Δ^2 + ϵ^2)) + -1 * sqrt((Δ^2 + ϵ^2) * (Δ^2 + 2 * ϵ * (ϵ + sqrt(Δ^2 + ϵ^2)))))) * (adjoint(a[1]) * adjoint(a[3])) + -1 * (ℯ^((1im) * (2 * ϕ[1] + ϕ[3])) * t^2 * Δ^2 * sqrt(Δ^2 + ϵ^2) * (adjoint(a[1]) * a[1])) + -1 * (2 * ℯ^((1im) * (ϕ[1] + ϕ[2] + ϕ[3])) * t^2 * Δ^2 * sqrt(Δ^2 + ϵ^2) * (adjoint(a[1]) * a[1])) + -1 * (ℯ^((1im) * (2 * ϕ[2] + ϕ[3])) * t^2 * Δ^2 * sqrt(Δ^2 + ϵ^2) * (adjoint(a[1]) * a[1])) + 2 * ℯ^((1im) * (ϕ[1] + ϕ[2] + ϕ[3])) * tso^2 * Δ^2 * sqrt(Δ^2 + ϵ^2) * (adjoint(a[1]) * a[1]) + 4 * ℯ^((1im) * (ϕ[1] + ϕ[2] + ϕ[3])) * tso^2 * ϵ^2 * sqrt(Δ^2 + ϵ^2) * (adjoint(a[1]) * a[1]) + -1 * (ℯ^((1im) * (2 * ϕ[1] + ϕ[3])) * tso^2 * Δ^2 * sqrt(Δ^2 + 2 * ϵ * (ϵ + sqrt(Δ^2 + ϵ^2))) * (adjoint(a[1]) * a[1])) + -1 * (ℯ^((1im) * (2 * ϕ[2] + ϕ[3])) * tso^2 * Δ^2 * sqrt(Δ^2 + 2 * ϵ * (ϵ + sqrt(Δ^2 + ϵ^2))) * (adjoint(a[1]) * a[1])) + -1 * (ℯ^((1im) * (2 * ϕ[1] + ϕ[3])) * tso^2 * ϵ^2 * sqrt(Δ^2 + 2 * ϵ * (ϵ + sqrt(Δ^2 + ϵ^2))) * (adjoint(a[1]) * a[1])) + -1 * (ℯ^((1im) * (2 * ϕ[2] + ϕ[3])) * tso^2 * ϵ^2 * sqrt(Δ^2 + 2 * ϵ * (ϵ + sqrt(Δ^2 + ϵ^2))) * (adjoint(a[1]) * a[1])) + ℯ^((1im) * (2 * ϕ[1] + ϕ[3])) * tso^2 * ϵ * sqrt((Δ^2 + ϵ^2) * (Δ^2 + 2 * ϵ * (ϵ + sqrt(Δ^2 + ϵ^2)))) * (adjoint(a[1]) * a[1]) + ℯ^((1im) * (2 * ϕ[2] + ϕ[3])) * tso^2 * ϵ * sqrt((Δ^2 + ϵ^2) * (Δ^2 + 2 * ϵ * (ϵ + sqrt(Δ^2 + ϵ^2)))) * (adjoint(a[1]) * a[1]) + -1 * (2 * ℯ^((1im) * (ϕ[1] + ϕ[2] + ϕ[3])) * tso^2 * Δ^2 * ϵ * (adjoint(a[1]) * a[3])) + 2 * ℯ^((1im) * (ϕ[2] + 2 * ϕ[3])) * tso^2 * Δ^2 * ϵ * (adjoint(a[1]) * a[3]) + -1 * (2 * ℯ^((1im) * (ϕ[1] + ϕ[2] + ϕ[3])) * tso^2 * ϵ^3 * (adjoint(a[1]) * a[3])) + 2 * ℯ^((1im) * (ϕ[2] + 2 * ϕ[3])) * tso^2 * ϵ^3 * (adjoint(a[1]) * a[3]) + -1 * (ℯ^((1im) * (ϕ[1] + ϕ[2] + ϕ[3])) * t^2 * Δ^2 * sqrt(Δ^2 + ϵ^2) * (adjoint(a[1]) * a[3])) + -1 * (ℯ^((1im) * (2 * ϕ[2] + ϕ[3])) * t^2 * Δ^2 * sqrt(Δ^2 + ϵ^2) * (adjoint(a[1]) * a[3])) + -1 * (ℯ^((1im) * (ϕ[1] + 2 * ϕ[3])) * t^2 * Δ^2 * sqrt(Δ^2 + ϵ^2) * (adjoint(a[1]) * a[3])) + -1 * (ℯ^((1im) * (ϕ[2] + 2 * ϕ[3])) * t^2 * Δ^2 * sqrt(Δ^2 + ϵ^2) * (adjoint(a[1]) * a[3])) + -1 * (ℯ^((1im) * (ϕ[1] + ϕ[2] + ϕ[3])) * tso^2 * Δ^2 * sqrt(Δ^2 + ϵ^2) * (adjoint(a[1]) * a[3])) + -1 * (ℯ^((1im) * (ϕ[2] + 2 * ϕ[3])) * tso^2 * Δ^2 * sqrt(Δ^2 + ϵ^2) * (adjoint(a[1]) * a[3])) + -1 * (2 * ℯ^((1im) * (ϕ[1] + ϕ[2] + ϕ[3])) * tso^2 * ϵ^2 * sqrt(Δ^2 + ϵ^2) * (adjoint(a[1]) * a[3])) + -1 * (2 * ℯ^((1im) * (ϕ[2] + 2 * ϕ[3])) * tso^2 * ϵ^2 * sqrt(Δ^2 + ϵ^2) * (adjoint(a[1]) * a[3])) + ℯ^((1im) * (2 * ϕ[2] + ϕ[3])) * tso^2 * Δ^2 * sqrt(Δ^2 + 2 * ϵ * (ϵ + sqrt(Δ^2 + ϵ^2))) * (adjoint(a[1]) * a[3]) + ℯ^((1im) * (ϕ[1] + 2 * ϕ[3])) * tso^2 * Δ^2 * sqrt(Δ^2 + 2 * ϵ * (ϵ + sqrt(Δ^2 + ϵ^2))) * (adjoint(a[1]) * a[3]) + ℯ^((1im) * (2 * ϕ[2] + ϕ[3])) * tso^2 * ϵ^2 * sqrt(Δ^2 + 2 * ϵ * (ϵ + sqrt(Δ^2 + ϵ^2))) * (adjoint(a[1]) * a[3]) + ℯ^((1im) * (ϕ[1] + 2 * ϕ[3])) * tso^2 * ϵ^2 * sqrt(Δ^2 + 2 * ϵ * (ϵ + sqrt(Δ^2 + ϵ^2))) * (adjoint(a[1]) * a[3]) + -1 * (ℯ^((1im) * (2 * ϕ[2] + ϕ[3])) * tso^2 * ϵ * sqrt((Δ^2 + ϵ^2) * (Δ^2 + 2 * ϵ * (ϵ + sqrt(Δ^2 + ϵ^2)))) * (adjoint(a[1]) * a[3])) + -1 * (ℯ^((1im) * (ϕ[1] + 2 * ϕ[3])) * tso^2 * ϵ * sqrt((Δ^2 + ϵ^2) * (Δ^2 + 2 * ϵ * (ϵ + sqrt(Δ^2 + ϵ^2)))) * (adjoint(a[1]) * a[3])) + -1 * (ℯ^((1im) * (ϕ[1] + 2 * ϕ[2])) * t^2 * Δ^2 * sqrt(Δ^2 + ϵ^2) * (adjoint(a[2]) * a[2])) + -1 * (ℯ^((1im) * (2 * ϕ[1] + ϕ[3])) * t^2 * Δ^2 * sqrt(Δ^2 + ϵ^2) * (adjoint(a[2]) * a[2])) + -1 * (4 * ℯ^((1im) * (ϕ[1] + ϕ[2] + ϕ[3])) * t^2 * Δ^2 * sqrt(Δ^2 + ϵ^2) * (adjoint(a[2]) * a[2])) + -1 * (ℯ^((1im) * (2 * ϕ[2] + ϕ[3])) * t^2 * Δ^2 * sqrt(Δ^2 + ϵ^2) * (adjoint(a[2]) * a[2])) + -1 * (ℯ^((1im) * (ϕ[1] + 2 * ϕ[3])) * t^2 * Δ^2 * sqrt(Δ^2 + ϵ^2) * (adjoint(a[2]) * a[2])) + 4 * ℯ^((1im) * (ϕ[1] + ϕ[2] + ϕ[3])) * tso^2 * Δ^2 * sqrt(Δ^2 + ϵ^2) * (adjoint(a[2]) * a[2]) + 8 * ℯ^((1im) * (ϕ[1] + ϕ[2] + ϕ[3])) * tso^2 * ϵ^2 * sqrt(Δ^2 + ϵ^2) * (adjoint(a[2]) * a[2]) + -1 * (ℯ^((1im) * (ϕ[1] + 2 * ϕ[2])) * tso^2 * Δ^2 * sqrt(Δ^2 + 2 * ϵ * (ϵ + sqrt(Δ^2 + ϵ^2))) * (adjoint(a[2]) * a[2])) + -1 * (ℯ^((1im) * (2 * ϕ[1] + ϕ[3])) * tso^2 * Δ^2 * sqrt(Δ^2 + 2 * ϵ * (ϵ + sqrt(Δ^2 + ϵ^2))) * (adjoint(a[2]) * a[2])) + -1 * (ℯ^((1im) * (2 * ϕ[2] + ϕ[3])) * tso^2 * Δ^2 * sqrt(Δ^2 + 2 * ϵ * (ϵ + sqrt(Δ^2 + ϵ^2))) * (adjoint(a[2]) * a[2])) + -1 * (ℯ^((1im) * (ϕ[1] + 2 * ϕ[3])) * tso^2 * Δ^2 * sqrt(Δ^2 + 2 * ϵ * (ϵ + sqrt(Δ^2 + ϵ^2))) * (adjoint(a[2]) * a[2])) + -1 * (ℯ^((1im) * (ϕ[1] + 2 * ϕ[2])) * tso^2 * ϵ^2 * sqrt(Δ^2 + 2 * ϵ * (ϵ + sqrt(Δ^2 + ϵ^2))) * (adjoint(a[2]) * a[2])) + -1 * (ℯ^((1im) * (2 * ϕ[1] + ϕ[3])) * tso^2 * ϵ^2 * sqrt(Δ^2 + 2 * ϵ * (ϵ + sqrt(Δ^2 + ϵ^2))) * (adjoint(a[2]) * a[2])) + -1 * (ℯ^((1im) * (2 * ϕ[2] + ϕ[3])) * tso^2 * ϵ^2 * sqrt(Δ^2 + 2 * ϵ * (ϵ + sqrt(Δ^2 + ϵ^2))) * (adjoint(a[2]) * a[2])) + -1 * (ℯ^((1im) * (ϕ[1] + 2 * ϕ[3])) * tso^2 * ϵ^2 * sqrt(Δ^2 + 2 * ϵ * (ϵ + sqrt(Δ^2 + ϵ^2))) * (adjoint(a[2]) * a[2])) + ℯ^((1im) * (ϕ[1] + 2 * ϕ[2])) * tso^2 * ϵ * sqrt((Δ^2 + ϵ^2) * (Δ^2 + 2 * ϵ * (ϵ + sqrt(Δ^2 + ϵ^2)))) * (adjoint(a[2]) * a[2]) + ℯ^((1im) * (2 * ϕ[1] + ϕ[3])) * tso^2 * ϵ * sqrt((Δ^2 + ϵ^2) * (Δ^2 + 2 * ϵ * (ϵ + sqrt(Δ^2 + ϵ^2)))) * (adjoint(a[2]) * a[2]) + ℯ^((1im) * (2 * ϕ[2] + ϕ[3])) * tso^2 * ϵ * sqrt((Δ^2 + ϵ^2) * (Δ^2 + 2 * ϵ * (ϵ + sqrt(Δ^2 + ϵ^2)))) * (adjoint(a[2]) * a[2]) + ℯ^((1im) * (ϕ[1] + 2 * ϕ[3])) * tso^2 * ϵ * sqrt((Δ^2 + ϵ^2) * (Δ^2 + 2 * ϵ * (ϵ + sqrt(Δ^2 + ϵ^2)))) * (adjoint(a[2]) * a[2]) + 2 * ℯ^((1im) * (2 * ϕ[1] + ϕ[2])) * tso^2 * Δ^2 * ϵ * (adjoint(a[3]) * a[1]) + -1 * (2 * ℯ^((1im) * (ϕ[1] + ϕ[2] + ϕ[3])) * tso^2 * Δ^2 * ϵ * (adjoint(a[3]) * a[1])) + 2 * ℯ^((1im) * (2 * ϕ[1] + ϕ[2])) * tso^2 * ϵ^3 * (adjoint(a[3]) * a[1]) + -1 * (2 * ℯ^((1im) * (ϕ[1] + ϕ[2] + ϕ[3])) * tso^2 * ϵ^3 * (adjoint(a[3]) * a[1])) + -1 * (ℯ^((1im) * (2 * ϕ[1] + ϕ[2])) * t^2 * Δ^2 * sqrt(Δ^2 + ϵ^2) * (adjoint(a[3]) * a[1])) + -1 * (ℯ^((1im) * (ϕ[1] + 2 * ϕ[2])) * t^2 * Δ^2 * sqrt(Δ^2 + ϵ^2) * (adjoint(a[3]) * a[1])) + -1 * (ℯ^((1im) * (2 * ϕ[1] + ϕ[3])) * t^2 * Δ^2 * sqrt(Δ^2 + ϵ^2) * (adjoint(a[3]) * a[1])) + -1 * (ℯ^((1im) * (ϕ[1] + ϕ[2] + ϕ[3])) * t^2 * Δ^2 * sqrt(Δ^2 + ϵ^2) * (adjoint(a[3]) * a[1])) + -1 * (ℯ^((1im) * (2 * ϕ[1] + ϕ[2])) * tso^2 * Δ^2 * sqrt(Δ^2 + ϵ^2) * (adjoint(a[3]) * a[1])) + -1 * (ℯ^((1im) * (ϕ[1] + ϕ[2] + ϕ[3])) * tso^2 * Δ^2 * sqrt(Δ^2 + ϵ^2) * (adjoint(a[3]) * a[1])) + -1 * (2 * ℯ^((1im) * (2 * ϕ[1] + ϕ[2])) * tso^2 * ϵ^2 * sqrt(Δ^2 + ϵ^2) * (adjoint(a[3]) * a[1])) + -1 * (2 * ℯ^((1im) * (ϕ[1] + ϕ[2] + ϕ[3])) * tso^2 * ϵ^2 * sqrt(Δ^2 + ϵ^2) * (adjoint(a[3]) * a[1])) + ℯ^((1im) * (ϕ[1] + 2 * ϕ[2])) * tso^2 * Δ^2 * sqrt(Δ^2 + 2 * ϵ * (ϵ + sqrt(Δ^2 + ϵ^2))) * (adjoint(a[3]) * a[1]) + ℯ^((1im) * (2 * ϕ[1] + ϕ[3])) * tso^2 * Δ^2 * sqrt(Δ^2 + 2 * ϵ * (ϵ + sqrt(Δ^2 + ϵ^2))) * (adjoint(a[3]) * a[1]) + ℯ^((1im) * (ϕ[1] + 2 * ϕ[2])) * tso^2 * ϵ^2 * sqrt(Δ^2 + 2 * ϵ * (ϵ + sqrt(Δ^2 + ϵ^2))) * (adjoint(a[3]) * a[1]) + ℯ^((1im) * (2 * ϕ[1] + ϕ[3])) * tso^2 * ϵ^2 * sqrt(Δ^2 + 2 * ϵ * (ϵ + sqrt(Δ^2 + ϵ^2))) * (adjoint(a[3]) * a[1]) + -1 * (ℯ^((1im) * (ϕ[1] + 2 * ϕ[2])) * tso^2 * ϵ * sqrt((Δ^2 + ϵ^2) * (Δ^2 + 2 * ϵ * (ϵ + sqrt(Δ^2 + ϵ^2)))) * (adjoint(a[3]) * a[1])) + -1 * (ℯ^((1im) * (2 * ϕ[1] + ϕ[3])) * tso^2 * ϵ * sqrt((Δ^2 + ϵ^2) * (Δ^2 + 2 * ϵ * (ϵ + sqrt(Δ^2 + ϵ^2)))) * (adjoint(a[3]) * a[1])) + -1 * (ℯ^((1im) * (ϕ[1] + 2 * ϕ[2])) * t^2 * Δ^2 * sqrt(Δ^2 + ϵ^2) * (adjoint(a[3]) * a[3])) + -1 * (2 * ℯ^((1im) * (ϕ[1] + ϕ[2] + ϕ[3])) * t^2 * Δ^2 * sqrt(Δ^2 + ϵ^2) * (adjoint(a[3]) * a[3])) + -1 * (ℯ^((1im) * (ϕ[1] + 2 * ϕ[3])) * t^2 * Δ^2 * sqrt(Δ^2 + ϵ^2) * (adjoint(a[3]) * a[3])) + 2 * ℯ^((1im) * (ϕ[1] + ϕ[2] + ϕ[3])) * tso^2 * Δ^2 * sqrt(Δ^2 + ϵ^2) * (adjoint(a[3]) * a[3]) + 4 * ℯ^((1im) * (ϕ[1] + ϕ[2] + ϕ[3])) * tso^2 * ϵ^2 * sqrt(Δ^2 + ϵ^2) * (adjoint(a[3]) * a[3]) + -1 * (ℯ^((1im) * (ϕ[1] + 2 * ϕ[2])) * tso^2 * Δ^2 * sqrt(Δ^2 + 2 * ϵ * (ϵ + sqrt(Δ^2 + ϵ^2))) * (adjoint(a[3]) * a[3])) + -1 * (ℯ^((1im) * (ϕ[1] + 2 * ϕ[3])) * tso^2 * Δ^2 * sqrt(Δ^2 + 2 * ϵ * (ϵ + sqrt(Δ^2 + ϵ^2))) * (adjoint(a[3]) * a[3])) + -1 * (ℯ^((1im) * (ϕ[1] + 2 * ϕ[2])) * tso^2 * ϵ^2 * sqrt(Δ^2 + 2 * ϵ * (ϵ + sqrt(Δ^2 + ϵ^2))) * (adjoint(a[3]) * a[3])) + -1 * (ℯ^((1im) * (ϕ[1] + 2 * ϕ[3])) * tso^2 * ϵ^2 * sqrt(Δ^2 + 2 * ϵ * (ϵ + sqrt(Δ^2 + ϵ^2))) * (adjoint(a[3]) * a[3])) + ℯ^((1im) * (ϕ[1] + 2 * ϕ[2])) * tso^2 * ϵ * sqrt((Δ^2 + ϵ^2) * (Δ^2 + 2 * ϵ * (ϵ + sqrt(Δ^2 + ϵ^2)))) * (adjoint(a[3]) * a[3]) + ℯ^((1im) * (ϕ[1] + 2 * ϕ[3])) * tso^2 * ϵ * sqrt((Δ^2 + ϵ^2) * (Δ^2 + 2 * ϵ * (ϵ + sqrt(Δ^2 + ϵ^2)))) * (adjoint(a[3]) * a[3]) + -1 * (2 * ℯ^((2 * (1im)) * (ϕ[1] + ϕ[3])) * t * tso * Δ^3 * (a[1] * a[3])) + -1 * (ℯ^((1im) * (2 * ϕ[1] + ϕ[2] + ϕ[3])) * t * tso * Δ^3 * (a[1] * a[3])) + -1 * (ℯ^((1im) * (ϕ[1] + ϕ[2] + 2 * ϕ[3])) * t * tso * Δ^3 * (a[1] * a[3])) + -1 * (2 * ℯ^((2 * (1im)) * (ϕ[1] + ϕ[3])) * t * tso * Δ * ϵ^2 * (a[1] * a[3])) + -1 * (ℯ^((1im) * (2 * ϕ[1] + ϕ[2] + ϕ[3])) * t * tso * Δ * ϵ^2 * (a[1] * a[3])) + -1 * (ℯ^((1im) * (ϕ[1] + ϕ[2] + 2 * ϕ[3])) * t * tso * Δ * ϵ^2 * (a[1] * a[3])) + 2 * ℯ^((2 * (1im)) * (ϕ[1] + ϕ[3])) * t * tso * Δ * ϵ * sqrt(Δ^2 + ϵ^2) * (a[1] * a[3]) + ℯ^((1im) * (2 * ϕ[1] + ϕ[2] + ϕ[3])) * t * tso * Δ * ϵ * sqrt(Δ^2 + ϵ^2) * (a[1] * a[3]) + ℯ^((1im) * (ϕ[1] + ϕ[2] + 2 * ϕ[3])) * t * tso * Δ * ϵ * sqrt(Δ^2 + ϵ^2) * (a[1] * a[3]) + ℯ^((1im) * (2 * ϕ[1] + ϕ[2] + ϕ[3])) * t * tso * Δ * sqrt((Δ^2 + ϵ^2) * (Δ^2 + 2 * ϵ * (ϵ + sqrt(Δ^2 + ϵ^2)))) * (a[1] * a[3]) + 2 * ℯ^((1im) * (ϕ[1] + 2 * ϕ[2] + ϕ[3])) * t * tso * Δ * sqrt((Δ^2 + ϵ^2) * (Δ^2 + 2 * ϵ * (ϵ + sqrt(Δ^2 + ϵ^2)))) * (a[1] * a[3]) + ℯ^((1im) * (ϕ[1] + ϕ[2] + 2 * ϕ[3])) * t * tso * Δ * sqrt((Δ^2 + ϵ^2) * (Δ^2 + 2 * ϵ * (ϵ + sqrt(Δ^2 + ϵ^2)))) * (a[1] * a[3])) *
    (4 * ℯ^((1im) * (ϕ[1] + ϕ[2] + ϕ[3])) * (Δ^2 + ϵ^2)^(3 * 2^-1) * (Vz + sqrt(Δ^2 + ϵ^2)))^-1
)#:((ℯ^((1im) * ϕ[3]) * (adjoint(a[1]) * a[1]) * (ℯ^((2 * (1im)) * ϕ[1]) * (t^2 + tso^2) * sqrt(-1 * μ[1] + sqrt(Δ^2 + μ[1]^2)) * sqrt(μ[1] + sqrt(Δ^2 + μ[1]^2)) * sqrt(-1 * μ[2] + sqrt(Δ^2 + μ[2]^2)) * sqrt(μ[2] + sqrt(Δ^2 + μ[2]^2)) + ℯ^((2 * (1im)) * ϕ[2]) * (t^2 + tso^2) * sqrt(-1 * μ[1] + sqrt(Δ^2 + μ[1]^2)) * sqrt(μ[1] + sqrt(Δ^2 + μ[1]^2)) * sqrt(-1 * μ[2] + sqrt(Δ^2 + μ[2]^2)) * sqrt(μ[2] + sqrt(Δ^2 + μ[2]^2)) + 2 * ℯ^((1im) * (ϕ[1] + ϕ[2])) * (t^2 * (-1 * (μ[1] * μ[2]) + sqrt(Δ^2 + μ[1]^2) * sqrt(Δ^2 + μ[2]^2)) + -1 * (tso^2 * (μ[1] * μ[2] + sqrt(Δ^2 + μ[1]^2) * sqrt(Δ^2 + μ[2]^2))))) * sqrt(Δ^2 + μ[3]^2) + ℯ^((1im) * ϕ[1]) * (adjoint(a[3]) * a[3]) * sqrt(Δ^2 + μ[1]^2) * (ℯ^((2 * (1im)) * ϕ[2]) * (t^2 + tso^2) * sqrt(-1 * μ[2] + sqrt(Δ^2 + μ[2]^2)) * sqrt(μ[2] + sqrt(Δ^2 + μ[2]^2)) * sqrt(-1 * μ[3] + sqrt(Δ^2 + μ[3]^2)) * sqrt(μ[3] + sqrt(Δ^2 + μ[3]^2)) + ℯ^((2 * (1im)) * ϕ[3]) * (t^2 + tso^2) * sqrt(-1 * μ[2] + sqrt(Δ^2 + μ[2]^2)) * sqrt(μ[2] + sqrt(Δ^2 + μ[2]^2)) * sqrt(-1 * μ[3] + sqrt(Δ^2 + μ[3]^2)) * sqrt(μ[3] + sqrt(Δ^2 + μ[3]^2)) + 2 * ℯ^((1im) * (ϕ[2] + ϕ[3])) * (t^2 * (-1 * (μ[2] * μ[3]) + sqrt(Δ^2 + μ[2]^2) * sqrt(Δ^2 + μ[3]^2)) + -1 * (tso^2 * (μ[2] * μ[3] + sqrt(Δ^2 + μ[2]^2) * sqrt(Δ^2 + μ[3]^2))))) + ℯ^(((1im) * 2^-1) * (ϕ[1] + ϕ[3])) * (Δ^2 + μ[1]^2)^(1 * 4^-1) * (Δ^2 + μ[3]^2)^(1 * 4^-1) * ((adjoint(a[1]) * a[3]) * (ℯ^((1im) * (ϕ[1] + ϕ[3])) * (t^2 + -1 * tso^2) * sqrt(μ[1] + sqrt(Δ^2 + μ[1]^2)) * sqrt(-1 * μ[2] + sqrt(Δ^2 + μ[2]^2)) * sqrt(μ[2] + sqrt(Δ^2 + μ[2]^2)) * sqrt(-1 * μ[3] + sqrt(Δ^2 + μ[3]^2)) + ℯ^((1im) * (ϕ[2] + ϕ[3])) * sqrt(-1 * μ[1] + sqrt(Δ^2 + μ[1]^2)) * (tso^2 * (-1 * μ[2] + sqrt(Δ^2 + μ[2]^2)) + t^2 * (μ[2] + sqrt(Δ^2 + μ[2]^2))) * sqrt(-1 * μ[3] + sqrt(Δ^2 + μ[3]^2)) + ℯ^((2 * (1im)) * ϕ[2]) * (t^2 + -1 * tso^2) * sqrt(-1 * μ[1] + sqrt(Δ^2 + μ[1]^2)) * sqrt(-1 * μ[2] + sqrt(Δ^2 + μ[2]^2)) * sqrt(μ[2] + sqrt(Δ^2 + μ[2]^2)) * sqrt(μ[3] + sqrt(Δ^2 + μ[3]^2)) + ℯ^((1im) * (ϕ[1] + ϕ[2])) * sqrt(μ[1] + sqrt(Δ^2 + μ[1]^2)) * (t^2 * (-1 * μ[2] + sqrt(Δ^2 + μ[2]^2)) + tso^2 * (μ[2] + sqrt(Δ^2 + μ[2]^2))) * sqrt(μ[3] + sqrt(Δ^2 + μ[3]^2))) + (adjoint(a[3]) * a[1]) * (ℯ^((2 * (1im)) * ϕ[2]) * (t^2 + -1 * tso^2) * sqrt(μ[1] + sqrt(Δ^2 + μ[1]^2)) * sqrt(-1 * μ[2] + sqrt(Δ^2 + μ[2]^2)) * sqrt(μ[2] + sqrt(Δ^2 + μ[2]^2)) * sqrt(-1 * μ[3] + sqrt(Δ^2 + μ[3]^2)) + ℯ^((1im) * (ϕ[1] + ϕ[2])) * sqrt(-1 * μ[1] + sqrt(Δ^2 + μ[1]^2)) * (tso^2 * (-1 * μ[2] + sqrt(Δ^2 + μ[2]^2)) + t^2 * (μ[2] + sqrt(Δ^2 + μ[2]^2))) * sqrt(-1 * μ[3] + sqrt(Δ^2 + μ[3]^2)) + ℯ^((1im) * (ϕ[1] + ϕ[3])) * (t^2 + -1 * tso^2) * sqrt(-1 * μ[1] + sqrt(Δ^2 + μ[1]^2)) * sqrt(-1 * μ[2] + sqrt(Δ^2 + μ[2]^2)) * sqrt(μ[2] + sqrt(Δ^2 + μ[2]^2)) * sqrt(μ[3] + sqrt(Δ^2 + μ[3]^2)) + ℯ^((1im) * (ϕ[2] + ϕ[3])) * sqrt(μ[1] + sqrt(Δ^2 + μ[1]^2)) * (t^2 * (-1 * μ[2] + sqrt(Δ^2 + μ[2]^2)) + tso^2 * (μ[2] + sqrt(Δ^2 + μ[2]^2))) * sqrt(μ[3] + sqrt(Δ^2 + μ[3]^2))) + 2 * t * tso * ((a[1] * a[3]) * (ℯ^((1im) * (ϕ[2] + ϕ[3])) * sqrt(μ[1] + sqrt(Δ^2 + μ[1]^2)) * μ[2] * sqrt(-1 * μ[3] + sqrt(Δ^2 + μ[3]^2)) + -1 * (ℯ^((1im) * (ϕ[1] + ϕ[3])) * sqrt(-1 * μ[1] + sqrt(Δ^2 + μ[1]^2)) * sqrt(-1 * μ[2] + sqrt(Δ^2 + μ[2]^2)) * sqrt(μ[2] + sqrt(Δ^2 + μ[2]^2)) * sqrt(-1 * μ[3] + sqrt(Δ^2 + μ[3]^2))) + ℯ^((1im) * (ϕ[1] + ϕ[2])) * sqrt(-1 * μ[1] + sqrt(Δ^2 + μ[1]^2)) * μ[2] * sqrt(μ[3] + sqrt(Δ^2 + μ[3]^2)) + ℯ^((2 * (1im)) * ϕ[2]) * sqrt(μ[1] + sqrt(Δ^2 + μ[1]^2)) * sqrt(-1 * μ[2] + sqrt(Δ^2 + μ[2]^2)) * sqrt(μ[2] + sqrt(Δ^2 + μ[2]^2)) * sqrt(μ[3] + sqrt(Δ^2 + μ[3]^2))) + (adjoint(a[1]) * adjoint(a[3])) * (-1 * (ℯ^((1im) * (ϕ[1] + ϕ[2])) * sqrt(μ[1] + sqrt(Δ^2 + μ[1]^2)) * μ[2] * sqrt(-1 * μ[3] + sqrt(Δ^2 + μ[3]^2))) + ℯ^((2 * (1im)) * ϕ[2]) * sqrt(-1 * μ[1] + sqrt(Δ^2 + μ[1]^2)) * sqrt(-1 * μ[2] + sqrt(Δ^2 + μ[2]^2)) * sqrt(μ[2] + sqrt(Δ^2 + μ[2]^2)) * sqrt(-1 * μ[3] + sqrt(Δ^2 + μ[3]^2)) + -1 * (ℯ^((1im) * (ϕ[2] + ϕ[3])) * sqrt(-1 * μ[1] + sqrt(Δ^2 + μ[1]^2)) * μ[2] * sqrt(μ[3] + sqrt(Δ^2 + μ[3]^2))) + -1 * (ℯ^((1im) * (ϕ[1] + ϕ[3])) * sqrt(μ[1] + sqrt(Δ^2 + μ[1]^2)) * sqrt(-1 * μ[2] + sqrt(Δ^2 + μ[2]^2)) * sqrt(μ[2] + sqrt(Δ^2 + μ[2]^2)) * sqrt(μ[3] + sqrt(Δ^2 + μ[3]^2)))))) + (adjoint(a[2]) * a[2]) * (ℯ^((1im) * (2 * ϕ[1] + ϕ[3])) * (t^2 + tso^2) * sqrt(-1 * μ[1] + sqrt(Δ^2 + μ[1]^2)) * sqrt(μ[1] + sqrt(Δ^2 + μ[1]^2)) * sqrt(-1 * μ[2] + sqrt(Δ^2 + μ[2]^2)) * sqrt(μ[2] + sqrt(Δ^2 + μ[2]^2)) * sqrt(Δ^2 + μ[3]^2) + ℯ^((1im) * (2 * ϕ[2] + ϕ[3])) * (t^2 + tso^2) * sqrt(-1 * μ[1] + sqrt(Δ^2 + μ[1]^2)) * sqrt(μ[1] + sqrt(Δ^2 + μ[1]^2)) * sqrt(-1 * μ[2] + sqrt(Δ^2 + μ[2]^2)) * sqrt(μ[2] + sqrt(Δ^2 + μ[2]^2)) * sqrt(Δ^2 + μ[3]^2) + ℯ^((1im) * (ϕ[1] + 2 * ϕ[2])) * (t^2 + tso^2) * sqrt(Δ^2 + μ[1]^2) * sqrt(-1 * μ[2] + sqrt(Δ^2 + μ[2]^2)) * sqrt(μ[2] + sqrt(Δ^2 + μ[2]^2)) * sqrt(-1 * μ[3] + sqrt(Δ^2 + μ[3]^2)) * sqrt(μ[3] + sqrt(Δ^2 + μ[3]^2)) + ℯ^((1im) * (ϕ[1] + 2 * ϕ[3])) * (t^2 + tso^2) * sqrt(Δ^2 + μ[1]^2) * sqrt(-1 * μ[2] + sqrt(Δ^2 + μ[2]^2)) * sqrt(μ[2] + sqrt(Δ^2 + μ[2]^2)) * sqrt(-1 * μ[3] + sqrt(Δ^2 + μ[3]^2)) * sqrt(μ[3] + sqrt(Δ^2 + μ[3]^2)) + ℯ^((1im) * (ϕ[1] + ϕ[2] + ϕ[3])) * (t^2 * (4 * sqrt(Δ^2 + μ[1]^2) * sqrt(Δ^2 + μ[2]^2) * sqrt(Δ^2 + μ[3]^2) + -1 * (2 * μ[2] * (sqrt(Δ^2 + μ[1]^2) * μ[3] + μ[1] * sqrt(Δ^2 + μ[3]^2)))) + -1 * (2 * tso^2 * (2 * sqrt(Δ^2 + μ[1]^2) * sqrt(Δ^2 + μ[2]^2) * sqrt(Δ^2 + μ[3]^2) + μ[2] * (sqrt(Δ^2 + μ[1]^2) * μ[3] + μ[1] * sqrt(Δ^2 + μ[3]^2))))))) * (4 * ℯ^((1im) * (ϕ[1] + ϕ[2] + ϕ[3])) * Vz * sqrt(Δ^2 + μ[1]^2) * sqrt(Δ^2 + μ[2]^2) * sqrt(Δ^2 + μ[3]^2))^-1)

##
##zeroth order
zerothorder_term = @RuntimeGeneratedFunction(:(function zerothorder(n, a, Δ, ϵ, Vz)
    $zerothorder_JUexp
end))
function zerothorder_perturbation(a; Δ, ε, Ez)
    N = length(a)
    sum(zerothorder_term(n, a, Δ, ε, Ez) for n in 1:N)
end
a = FermionBdGBasis(1:3)
zerothorder_term(3, a, 1, 1, 1)

##first order
firstorder_hopping_ex = :(function firstorder_hopping(n, a, Δ, ϵ, ϕ, tso, t)
    $firstorder_hopping_JUexp
end)
firstorder_hopping_term = @RuntimeGeneratedFunction(firstorder_hopping_ex)
function firstorder_perturbation(a; Δ, ε, δϕ, tso, t)
    N = length(a)
    ϕ = pushfirst!(cumsum(δϕ), 0)
    sum(firstorder_hopping_term(n, a, Δ, ε, ϕ, tso, t) for n in 1:N-1)
end
a = FermionBdGBasis(1:3)
firstorder_perturbation(a; Δ=1, ε=1, δϕ=1:2, tso=1, t=1 / 5)
firstorder_hopping_term(1, a, 1.0, rand(), rand(3), 0.2, 0.2)

## second order
secondorder_hopping_ex = :(function secondorder_hopping(a, Δ, ϵ, ϕ, tso, t, Vz)
    if length(a) == 3
        return $secondorder_N3_nonint_JUexp
    elseif length(a) == 2
        return $secondorder_N2_nonint_JUexp
    else
        throw(ArgumentError("Only N=2 or N=3 supported"))
    end
end);
secondorder_hopping_term = @RuntimeGeneratedFunction(secondorder_hopping_ex)
function secondorder_perturbation(a; Δ, ε, δϕ, tso, t, Ez)
    ϕ = pushfirst!(cumsum(δϕ), 0)
    secondorder_hopping_term(a, Δ, ε, ϕ, tso, t, Ez)
end
a = FermionBdGBasis(1:3)
secondorder_hopping_term(a, 1, 1, 1:3, 1, 1, 2)
secondorder_perturbation(a; Δ=1, ε=1, δϕ=1:2, tso=1, t=1 / 5, Ez=3)

# Base.:*(a::QuantumDots.BdGFermion, b::QuantumDots.BdGFermion, c::QuantumDots.BdGFermion, d::QuantumDots.BdGFermion) = 0 * (a * b)

##
function theta_to_ts(θ::Number, t)
    N = sqrt(1 + tan(θ / 2)^2)
    (t / N, t * tan(θ / 2) / N)
end
function theta_to_ts(θ::QuantumDots.DiffChainParameter, t)
    theta_to_ts(θ.value, t)
end
function perturbative_hamiltonian(a, M; Δ, ε, δϕ, t, θ, Ez)
    t, tso = theta_to_ts(θ, t)
    _perturbative_hamiltonian(a, M; Δ, ε, δϕ, tso, t, Ez)
end
function perturbative_hamiltonian_terms(a; Δ, ε, δϕ, t, θ, Ez)
    t, tso = theta_to_ts(θ, t)
    _perturbative_hamiltonian_terms(a; Δ, ε, δϕ, tso, t, Ez)
end
function _perturbative_hamiltonian_terms(a; Δ, ε, δϕ, tso, t, Ez)
    [zerothorder_perturbation(a; Δ, ε, Ez),
        firstorder_perturbation(a; Δ, ε, δϕ, tso, t),
        secondorder_perturbation(a; Δ, ε, δϕ, tso, t, Ez)]
end
function _perturbative_hamiltonian(a, M; Δ, ε, δϕ, tso, t, Ez)
    perts = _perturbative_hamiltonian_terms(a; Δ, ε, δϕ, tso, t, Ez)
    if rand() < 0.001
        println(norm.(perts))
    end
    return sum(perts[1:M+1])
end
perturbative_hamiltonian(a, 2; Δ=1, ε=1, δϕ=1:2, t=1 / 100000, θ=2.7, Ez=3) - zerothorder_perturbation(a; Δ=1, ε=1, Ez=3) |> norm
